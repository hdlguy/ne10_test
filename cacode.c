#include <stdint.h>

void cacode(int sv, int OS, uint8_t* ca_up) 
{

    // list of 10 bit octal strings that represent the first 10 bits of the gold code.
    // NOTE: octal format
    uint16_t first_ten[139] = {
        // the GPS codes
        00000,  // prn 0 is invalid
        01440,
        01620,
        01710,
        01744,
        01133,
        01455,
        01131,
        01454,
        01626,

        01504, // 10
        01642,
        01750,
        01764,
        01772,
        01775,
        01776,
        01156,
        01467,
        01633,

        01715, // 20
        01746,
        01763,
        01063,
        01706,
        01743,
        01761,
        01770,
        01774,
        01127,

        01453, // 30
        01625,
        01712,
        01745,
        01713,
        01134,
        01456,
        01713,

        // invalid codes
        00000,
        00000,

        00000, // 40
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        00000, // 50
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        00000, // 60
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        00000, // 70
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        00000, // 80
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        00000, // 90
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        00000, // 100
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        00000, // 110
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,
        00000,

        // the waas codes
        00671, // 120
        00536,
        01510,
        01545,
        00160,
        00701,
        00013,
        01060,
        00245,
        00527,
    
        01436, // 130
        01226,
        01257,
        00046,
        01071,
        00561,
        01037,
        00770,
        01327
    };

    // initialize the shift registers.
    uint8_t g1[10], g2[10];
    for (int i=0; i<10; i++) {
        g1[i] = 1;
        g2[i] = ~((first_ten[sv]) >> i) & 0x0001;
    }

    // compute the 1023 codes
    uint8_t ca[1023];
    ca[0] = g2[9] ^ g1[9];
    for (int i=1; i<1023; i++) {
        uint8_t temp;
        // run the g1 lfsr
        temp = g1[2] ^ g1[9];
        for (int j=9; j>0; j--) g1[j] = g1[j-1];
        g1[0] = temp;
        // run the g2 lfsr
        temp = g2[1] ^ g2[2] ^ g2[5]  ^ g2[7]  ^ g2[8]  ^ g2[9];
        for (int j=9; j>0; j--) g2[j] = g2[j-1];
        g2[0] = temp;
        // xor the two lfsr outputs
        ca[i] = g2[9] ^ g1[9];
    }

    // upsample by repeating each chip
    for (int i=0; i<1023; i++) {
        for (int j=0; j<OS; j++) {
            ca_up[i*OS+j] = ca[i];
        }
    }
    
}

